<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Enhanced Position Grouping</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
        }
        h1, h2, h3, h4, h5, h6 {
            color: #2c3e50;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }
        h1 { border-bottom: 2px solid #3498db; padding-bottom: 0.3em; }
        h2 { border-bottom: 1px solid #ecf0f1; padding-bottom: 0.2em; }
        code {
            background-color: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
        }
        pre {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 1em;
            overflow-x: auto;
        }
        pre code {
            background-color: transparent;
            padding: 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #3498db;
            color: white;
        }
        blockquote {
            border-left: 4px solid #3498db;
            margin: 1em 0;
            padding-left: 1em;
            color: #666;
        }
        a {
            color: #3498db;
            text-decoration: none;
        }
        .mermaid {
            text-align: center;
            margin: 2em 0;
            padding: 1em;
            background-color: #f8f8f8;
            border-radius: 4px;
        }
        .pdf-link {
            display: inline-block;
            margin: 10px 0;
            padding: 8px 16px;
            background-color: #e74c3c;
            color: white;
            border-radius: 4px;
            text-decoration: none;
        }
        .pdf-link:hover {
            background-color: #c0392b;
        }
    </style>
    <!-- Mermaid.js for diagram rendering -->
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true, theme: 'default' });
    </script>
</head>
<body>
    <p><a href="Enhanced Position Grouping.pdf" class="pdf-link">üìÑ Download PDF Version</a></p>
    <p>ENHANCED POSITION &amp; ORDER GROUPING STRUCTURE
1. CORE HIERARCHY CONCEPT</p>
<pre class="codehilite"><code class="language-mermaid">graph TB
    A[&quot;üìä Trading Account (Tag 1)&quot;] --&gt; B[&quot;üì¶ Position Aggregate&lt;br/&gt;Hash(Symbol + Account + TradingDay)&quot;]

    B --&gt; C[&quot;üéØ Root Intent&lt;br/&gt;Original Strategy/Goal&quot;]

    C --&gt; D[&quot;üîó Order Chain 1&lt;br/&gt;Entry Sequence&quot;]
    C --&gt; E[&quot;üîó Order Chain 2&lt;br/&gt;Stop-Loss Sequence&quot;]
    C --&gt; F[&quot;üîó Order Chain 3&lt;br/&gt;Take-Profit Sequence&quot;]

    D --&gt; G[&quot;üìÑ Order Node A&lt;br/&gt;Tag 37: ORD001&lt;br/&gt;Entry 1000@150.00&quot;]
    G --&gt; H[&quot;üíé Execution Node 1&lt;br/&gt;Tag 17: EXE001&lt;br/&gt;500@150.01&quot;]
    G --&gt; I[&quot;üíé Execution Node 2&lt;br/&gt;Tag 17: EXE002&lt;br/&gt;500@149.99&quot;]

    E --&gt; J[&quot;üìÑ Order Node B&lt;br/&gt;Tag 41: ORD001&lt;br/&gt;STP @145.00&quot;]
    J --&gt; K[&quot;üíé Execution Node 3&lt;br/&gt;Tag 17: EXE003&lt;br/&gt;1000@144.95&quot;]

    F --&gt; L[&quot;üìÑ Order Node C&lt;br/&gt;Tag 41: ORD001&lt;br/&gt;LMT @155.00&quot;]
    L --&gt; M[&quot;üíé Execution Node 4&lt;br/&gt;Tag 17: EXE004&lt;br/&gt;500@155.01&quot;]

    style B fill:#e1f5fe
    style C fill:#f3e5f5
    style D fill:#e8f5e8
    style E fill:#fff3e0
    style F fill:#fce4ec
</code></pre>

<ol>
<li>ORDER AGGREGATION RULES MATRIX
Message Type    Tag 35  Parent-Child Logic  Aggregation Rule
New Order Single    D   Root node creation  Start new order chain with ClOrdID
Execution Report    8   Child execution to parent order Link via OrderID (Tag 37)
Order Cancel Request    F   Child cancellation  OrigClOrdID ‚Üí Find parent order
Order Cancel/Replace    G   Child modification  OrigClOrdID ‚Üí Find parent, create new branch
Order Cancel Reject 9   Child rejection event   Link to parent cancellation request</li>
<li>COMPLETE GROUPING ALGORITHM FLOW</li>
</ol>
<pre class="codehilite"><code class="language-mermaid">flowchart TD
    Start[&quot;üì® Receive FIX Message&quot;] --&gt; Parse[&quot;üîç Extract Key Tags&lt;br/&gt;‚Ä¢ Tag 11: ClOrdID&lt;br/&gt;‚Ä¢ Tag 37: OrderID&lt;br/&gt;‚Ä¢ Tag 41: OrigClOrdID&quot;]

    Parse --&gt; Decision1{Tag 41 Exists?&lt;br/&gt;OrigClOrdID}

    Decision1 --&gt;|Yes| FindParent[&quot;üîó Find Parent Order&lt;br/&gt;Search: ClOrdID ‚Üí OrigClOrdID&quot;]
    Decision1 --&gt;|No| Decision2{Tag 37 Exists?&lt;br/&gt;OrderID}

    FindParent --&gt; ParentFound{Parent Found?}
    ParentFound --&gt;|Yes| CreateChild[&quot;üë∂ Create Child Node&lt;br/&gt;‚Ä¢ Link to Parent&lt;br/&gt;‚Ä¢ Store relationship&quot;]
    ParentFound --&gt;|No| OrphanPath[&quot;‚ö†Ô∏è Orphan Detected&lt;br/&gt;Create Temp Parent&quot;]

    Decision2 --&gt;|Yes| FindExisting[&quot;üîé Search OrderID Index&quot;]
    Decision2 --&gt;|No| Decision3{Tag 11 Exists?&lt;br/&gt;ClOrdID}

    FindExisting --&gt; ExistingFound{Order Exists?}
    ExistingFound --&gt;|Yes| UpdateNode[&quot;‚úèÔ∏è Update Existing Node&lt;br/&gt;‚Ä¢ Status changes&lt;br/&gt;‚Ä¢ Add executions&quot;]
    ExistingFound --&gt;|No| CreateNew[&quot;üÜï Create New Order Node&lt;br/&gt;‚Ä¢ Initialize state&lt;br/&gt;‚Ä¢ Start new chain&quot;]

    Decision3 --&gt;|Yes| TrackTemporary[&quot;‚è≥ Track by ClOrdID&lt;br/&gt;Await OrderID assignment&quot;]
    Decision3 --&gt;|No| Unlinkable[&quot;üö´ Cannot Link&lt;br/&gt;Log for manual review&quot;]

    CreateChild --&gt; AggregateMetrics[&quot;üìä Aggregate Chain Metrics&quot;]
    UpdateNode --&gt; AggregateMetrics
    CreateNew --&gt; AggregateMetrics
    TrackTemporary --&gt; AggregateMetrics

    AggregateMetrics --&gt; Recalculate[&quot;üßÆ Recalculate Totals&lt;br/&gt;‚Ä¢ Cumulative Qty&lt;br/&gt;‚Ä¢ Average Price&lt;br/&gt;‚Ä¢ P&amp;L status&quot;]

    Recalculate --&gt; DetectPatterns[&quot;üîé Detect Patterns&quot;]

    DetectPatterns --&gt; STPCheck[&quot;‚ö° STP Detection&quot;]
    DetectPatterns --&gt; GhostCheck[&quot;üëª Ghost Order Detection&quot;]
    DetectPatterns --&gt; OrphanCheck[&quot;‚ùì Orphan Resolution&quot;]

    STPCheck --&gt; Scoring[&quot;üìà Calculate STP Score&lt;br/&gt;Speed √ó Automation √ó Consistency&quot;]
    GhostCheck --&gt; Timeout[&quot;‚è∞ Check timeouts&lt;br/&gt;30s New, 10s Cancel&quot;]
    OrphanCheck --&gt; LinkAttempt[&quot;üîÑ Attempt late linking&quot;]

    Scoring --&gt; UpdateUI[&quot;üñ•Ô∏è Update Dashboard&lt;br/&gt;‚Ä¢ Parent group view&lt;br/&gt;‚Ä¢ Child hierarchy&lt;br/&gt;‚Ä¢ STP indicators&quot;]
    Timeout --&gt; Alert[&quot;üö® Create Alert&lt;br/&gt;‚Ä¢ Plane ticket&lt;br/&gt;‚Ä¢ Telegram notification&quot;]
    LinkAttempt --&gt; Reconciliation[&quot;üìù Manual review queue&quot;]

    UpdateUI --&gt; End[&quot;‚úÖ Processing Complete&quot;]
    Alert --&gt; End
    Reconciliation --&gt; End
</code></pre>

<ol>
<li>DATABASE SCHEMA FOR HIERARCHICAL STORAGE</li>
</ol>
<pre class="codehilite"><code class="language-mermaid">erDiagram
    POSITION_AGGREGATE {
        string position_id PK &quot;Hash(Account+Symbol+Date)&quot;
        string account FK &quot;Tag 1&quot;
        string symbol &quot;Tag 55&quot;
        date trading_date
        decimal net_quantity
        decimal avg_entry_price
        decimal realized_pnl
        string position_status &quot;OPEN|CLOSED|EXPIRED&quot;
        json metadata &quot;Custom fields&quot;
    }

    ORDER_CHAIN {
        string chain_id PK &quot;UUID&quot;
        string position_id FK
        string root_order_id &quot;First OrderID in chain&quot;
        string chain_type &quot;ENTRY|STOP_LOSS|TAKE_PROFIT|TRAILING_STOP&quot;
        timestamp chain_start
        timestamp chain_end
        decimal chain_pnl
    }

    ORDER_NODE {
        string node_id PK &quot;UUID&quot;
        string chain_id FK
        string order_id &quot;Tag 37&quot;
        string clord_id &quot;Tag 11&quot;
        string orig_clord_id &quot;Tag 41&quot;
        string msg_type &quot;Tag 35&quot;
        string ord_status &quot;Tag 39&quot;
        string exec_type &quot;Tag 150&quot;
        decimal order_qty &quot;Tag 38&quot;
        decimal cum_qty &quot;Tag 14&quot;
        decimal leaves_qty &quot;Tag 151&quot;
        timestamp transact_time &quot;Tag 60&quot;
        boolean is_stp_candidate
        boolean is_ghost_candidate
        json raw_message &quot;Full FIX message&quot;
    }

    EXECUTION_NODE {
        string exec_id PK &quot;Tag 17&quot;
        string node_id FK
        decimal last_qty &quot;Tag 31&quot;
        decimal last_px &quot;Tag 32&quot;
        timestamp exec_time
        string exec_trans_type &quot;Tag 20&quot;
        string settl_date &quot;Tag 64&quot;
    }

    RELATIONSHIP_LOG {
        string log_id PK
        string parent_node_id FK
        string child_node_id FK
        string relationship_type &quot;CANCEL|REPLACE|FILL|REJECT&quot;
        timestamp created_at
        string evidence &quot;Tags proving relationship&quot;
    }

    POSITION_AGGREGATE ||--o{ ORDER_CHAIN : contains
    ORDER_CHAIN ||--o{ ORDER_NODE : comprises
    ORDER_NODE ||--o{ EXECUTION_NODE : has
    ORDER_NODE ||--o{ RELATIONSHIP_LOG : participates_in
</code></pre>

<ol>
<li>USER DRILL-DOWN NAVIGATION PATH</li>
</ol>
<pre class="codehilite"><code class="language-mermaid">flowchart LR
    A[&quot;Level 1: Dashboard&lt;br/&gt;All Positions Summary&quot;] --&gt; 
    B[&quot;Level 2: Position Detail&lt;br/&gt;Single Symbol P&amp;L Timeline&quot;]

    B --&gt; 
    C[&quot;Level 3: Order Chains&lt;br/&gt;Entry/Stop/TP Sequences&quot;]

    C --&gt; 
    D[&quot;Level 4: Order Node&lt;br/&gt;Individual Order Lifecycle&quot;]

    D --&gt; 
    E[&quot;Level 5: Execution Details&lt;br/&gt;Fill-by-Fill Analysis&quot;]

    E --&gt; 
    F[&quot;Level 6: Raw FIX Messages&lt;br/&gt;Tag-by-Tag Inspection&quot;]

    subgraph &quot;Navigation Controls&quot;
        G[&quot;üîç Filter by:&quot;] --&gt; H[&quot;‚Ä¢ Date Range&lt;br/&gt;‚Ä¢ Symbol&lt;br/&gt;‚Ä¢ Strategy&lt;br/&gt;‚Ä¢ STP Score&quot;]
        I[&quot;üìä View Options:&quot;] --&gt; J[&quot;‚Ä¢ Hierarchy Tree&lt;br/&gt;‚Ä¢ Timeline View&lt;br/&gt;‚Ä¢ P&amp;L Attribution&lt;br/&gt;‚Ä¢ Audit Trail&quot;]
    end

    style A fill:#e3f2fd
    style B fill:#f3e5f5
    style C fill:#e8f5e8
    style D fill:#fff3e0
    style E fill:#fce4ec
    style F fill:#ffebee
</code></pre>

<ol>
<li>STP DETECTION LOGIC MATRIX
Detection Point Tags to Monitor Threshold   STP Score Impact
Speed Factor    Tag 60 (TransactTime) between New(0) ‚Üí Filled(2)    &lt; 2 seconds +40 points
Automation Factor   No manual intervention messages (F/G) between fills Zero messages   +40 points
Consistency Factor  Tag 32 (LastPx) variance within spread  &lt; 0.1%  +20 points
Volume Pattern  Tag 31 (LastQty) matches original Tag 38 (OrderQty) 95-105% +10 points
Session Continuity  Same Tag 49 (SenderCompID) and Tag 56 (TargetCompID)    Identical   +10 points</li>
<li>GHOST ORDER DETECTION STATES</li>
</ol>
<pre class="codehilite"><code class="language-mermaid">stateDiagram-v2
    [*] --&gt; PENDING_NEW : Tag 39=A
    PENDING_NEW --&gt; NEW : Tag 39=0
    PENDING_NEW --&gt; REJECTED : Tag 39=8
    PENDING_NEW --&gt; GHOST_TIMEOUT : No update &gt; 5s

    NEW --&gt; PARTIAL_FILL : Tag 39=1
    NEW --&gt; FILLED : Tag 39=2
    NEW --&gt; CANCELLED : Tag 39=4
    NEW --&gt; GHOST_STALLED : No update &gt; 30s

    PARTIAL_FILL --&gt; FILLED : Tag 39=2
    PARTIAL_FILL --&gt; CANCELLED : Tag 39=4
    PARTIAL_FILL --&gt; GHOST_PARTIAL : No update &gt; 60s

    FILLED --&gt; [*] : Terminal State
    CANCELLED --&gt; [*] : Terminal State
    REJECTED --&gt; [*] : Terminal State

    GHOST_TIMEOUT --&gt; MANUAL_REVIEW : Alert Created
    GHOST_STALLED --&gt; MANUAL_REVIEW : Alert Created
    GHOST_PARTIAL --&gt; MANUAL_REVIEW : Alert Created

    MANUAL_REVIEW --&gt; RESOLVED : Linked/Closed
    MANUAL_REVIEW --&gt; ESCALATED : Requires Action

    note right of GHOST_TIMEOUT
        Type 1: No initial response
        Common with connectivity issues
    end note

    note right of GHOST_STALLED
        Type 2: Stuck in NEW state
        Exchange/risk hold suspected
    end note

    note right of GHOST_PARTIAL
        Type 3: Partial fill orphan
        Market depth/queue issues
    end note
</code></pre>

<ol>
<li>REAL-TIME AGGREGATION PIPELINE</li>
</ol>
<pre class="codehilite"><code class="language-mermaid">graph TB
    subgraph &quot;Ingestion Layer&quot;
        A[FIX TCP Stream] --&gt; B[Message Parser]
        B --&gt; C[Tag Extractor]
        C --&gt; D[Sequence Validator&lt;br/&gt;Tag 34, 52]
    end

    subgraph &quot;Processing Layer&quot;
        D --&gt; E[Relationship Matcher]
        E --&gt; F[Parent-Child Linker]
        F --&gt; G[Order Graph Builder]
        G --&gt; H[Metric Aggregator]
        H --&gt; I[Pattern Detector&lt;br/&gt;STP/Ghost/Orphan]
    end

    subgraph &quot;Storage Layer&quot;
        I --&gt; J[ChaiSQL Write]
        J --&gt; K[Order Graph DB]
        J --&gt; L[Metrics Cache]
        J --&gt; M[Alert Queue]
    end

    subgraph &quot;Output Layer&quot;
        K --&gt; N[WebSocket Broadcast]
        L --&gt; O[API Endpoints]
        M --&gt; P[Plane Integration]
        M --&gt; Q[Telegram Bot]
    end

    subgraph &quot;Query Layer&quot;
        N --&gt; R[Dashboard Updates]
        O --&gt; S[Client Applications]
        P --&gt; T[Issue Management]
        Q --&gt; U[Mobile Alerts]
    end

    subgraph &quot;Analytics Layer&quot;
        R --&gt; V[Real-time Monitoring]
        S --&gt; W[Historical Analysis]
        T --&gt; X[Incident Tracking]
        U --&gt; Y[Notification Log]
    end
</code></pre>

<ol>
<li>KEY IMPLEMENTATION INSIGHTS
Dual Index Strategy: Maintain both OrderID ‚Üí Node and ClOrdID ‚Üí Node mappings for fast lookups during the order lifecycle.</li>
</ol>
<p>Late Binding: Some relationships only become clear later (e.g., a cancel referencing an order that hasn't been indexed yet). Implement a pending relationship queue.</p>
<p>Eventual Consistency: The complete picture may take multiple messages. Build with idempotent updates and state reconciliation.</p>
<p>Temporal Analysis: Use TransactTime (Tag 60) for sequencing when MsgSeqNum (Tag 34) has gaps or resets.</p>
<p>Context Preservation: Store the raw FIX message with each node for audit trails and debugging relationship decisions.</p>
<p>This structure provides a comprehensive framework for building position history with intuitive parent-child grouping that users can drill down through, while handling all the edge cases you've identified in your analysis.</p>
</body>
</html>